<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KNP Visitor Management System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!--icon image-->
    <!-- Corrected KNP Logo path for Canvas environment -->
    <link rel="icon" href="KNP LOGO.jpeg" type="image/jpeg">
    <style>
        /* Custom styles for Inter font and general body styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            color: #1f2937; /* Dark gray text */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container {
            max-width: 1280px; /* Equivalent to mx-auto max-w-screen-xl */
            margin-left: auto;
            margin-right: auto;
            padding: 1rem; /* Equivalent to p-4 */
        }
        /* Basic button styling for consistency if not fully covered by Tailwind */
        button {
            cursor: pointer;
        }
        /* Table responsive overflow */
        .overflow-x-auto {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* For smooth scrolling on iOS */
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 font-sans text-gray-900">

    <!-- Login Screen -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen bg-gray-100 p-4">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
            <h2 class="text-3xl font-bold mb-6 text-center text-green-700">KNP-VMS Login</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="loginEmail" class="block text-sm font-medium text-gray-700">Email:</label>
                    <!-- Default email for testing -->
                    <input type="email" id="loginEmail" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="your@email.com" value="test@example.com" required />
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700">Password:</label>
                    <!-- Default password for testing -->
                    <input type="password" id="loginPassword" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" value="password123" required />
                </div>
                <button type="submit" id="loginSubmitButton" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out" disabled>
                    Login
                </button>
            </form>
            <p id="login-message" class="mt-4 text-center text-sm font-medium text-red-600"></p>
        </div>
    </div>

    <!-- Main Application Content -->
    <div id="main-app-content" class="flex-grow hidden">
        <nav class="bg-green-800 p-4 shadow-md">
            <div class="container mx-auto flex flex-wrap justify-between items-center">
                <!-- Hamburger menu button (always visible now) -->
                <button id="hamburger-button" class="text-white text-3xl focus:outline-none mr-4">
                    &#9776; <!-- Unicode for hamburger icon -->
                </button>
                <!-- KNP Logo -->
                <img src="KNP LOGO.jpeg" alt="KNP Logo" class="h-10 w-10 mr-2 rounded-full object-cover">
                <div class="text-white text-2xl font-bold">KNP-VMS</div>

                <!-- Navigation links container (always hidden by default, toggled by JS) -->
                <div id="nav-links-container" class="w-full hidden flex-grow justify-center mt-2 md:mt-0">
                    <ul class="flex flex-col space-y-2 text-white text-lg w-full">
                        <li>
                            <button id="navRegisterVisitor" class="block w-full text-left py-2 px-4 rounded-md transition duration-300 ease-in-out hover:bg-green-700">
                                Register Visitor
                            </button>
                        </li>
                        <li>
                            <button id="navPrincipalBooking" class="block w-full text-left py-2 px-4 rounded-md transition duration-300 ease-in-out hover:bg-green-700">
                                Principal Booking
                            </button>
                        </li>
                        <li>
                            <button id="navPrincipalApproval" class="block w-full text-left py-2 px-4 rounded-md transition duration-300 ease-in-out hover:bg-green-700">
                                Principal Approval
                            </button>
                        </li>
                        <li>
                            <button id="navDashboard" class="block w-full text-left py-2 px-4 rounded-md transition duration-300 ease-in-out hover:bg-green-700">
                                Dashboard
                            </button>
                        </li>
                        <li>
                            <button id="navVisitorLogs" class="block w-full text-left py-2 px-4 rounded-md transition duration-300 ease-in-out hover:bg-green-700">
                                Visitor Logs
                            </button>
                        </li>
                        <li>
                            <button id="navCreateStaffUser" class="block w-full text-left py-2 px-4 rounded-md transition duration-300 ease-in-out hover:bg-green-700">
                                Create Staff User
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="text-white text-lg mt-2 md:mt-0">
                    <button id="logoutButton" class="bg-red-600 hover:bg-red-700 py-2 px-4 rounded-md transition duration-300 ease-in-out">
                        Logout (<span id="loggedInUserEmail">Admin</span>)
                    </button>
                </div>
            </div>
        </nav>

        <div id="app-content" class="container mx-auto p-4 mt-8 flex-grow">
            <!-- Content will be rendered here by JavaScript -->
        </div>

        <!-- Display current userId for multi-user app identification -->
        <!-- The 'hidden' class is added to prevent displaying the User ID -->
        <div id="user-id-display" class="fixed bottom-4 left-4 bg-gray-800 text-white p-2 rounded-md text-sm shadow-lg hidden">
            User ID: <span id="current-user-id"></span>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div id="privacyModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 m-4 max-w-2xl w-full relative">
            <button id="closePrivacyModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h3 class="text-2xl font-bold mb-4 text-green-700 text-center">KNP Visitor Data Privacy Policy</h3>
            <div class="text-gray-700 space-y-4 text-sm">
                <p>This system collects your Full Name, Phone Number, ID Number, Time of Visit (Check-in and Check-out), and Purpose of Visit for security and record-keeping purposes of the Kisii National Polytechnic.</p>
                <p>Your data will be processed strictly in accordance with the <strong>Data Protection Act, 2019, of Kenya</strong>.</p>
                <p class="font-semibold">Key principles:</p>
                <ul class="list-disc list-inside ml-4 space-y-2">
                    <li><strong>Lawfulness and Fairness:</strong> Data is collected for legitimate purposes only.</li>
                    <li><strong>Purpose Limitation:</strong> Data will only be used for visitor management and security.</li>
                    <li><strong>Data Minimization:</strong> Only necessary data is collected.</li>
                    <li><strong>Confidentiality:</strong> Your data will be protected from unauthorized access and will not be shared with unauthorized third parties.</li>
                    <li><strong>Storage Limitation:</strong> Data will be retained for a necessary period as per KNP's policy for security audits and then securely disposed of.</li>
                </ul>
                <p>By proceeding with check-in, you consent to this data collection and processing as described. For more details or to exercise your data rights, please contact the KNP administration.</p>
            </div>
            <div class="mt-6 text-center">
                <button id="modalCloseButton" class="bg-green-600 text-white py-2 px-6 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Reject Reason Modal -->
    <div id="rejectReasonModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 m-4 max-w-md w-full relative">
            <button id="closeRejectReasonModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h3 class="text-2xl font-bold mb-4 text-green-700 text-center">Reject Appointment</h3>
            <div class="text-gray-700 space-y-4">
                <div>
                    <label for="rejectionReasonSelect" class="block text-sm font-medium text-gray-700">Reason for Rejection:</label>
                    <select id="rejectionReasonSelect" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        <option value="">-- Select a Reason --</option>
                        <option value="Not available">Principal not available</option>
                        <option value="Conflicting schedule">Conflicting schedule</option>
                        <option value="Purpose unclear">Purpose of visit unclear</option>
                        <option value="Other">Other (please specify)</option>
                    </select>
                </div>
                <div id="customReasonContainer" class="hidden">
                    <label for="customRejectionReason" class="block text-sm font-medium text-gray-700">Custom Reason:</label>
                    <textarea id="customRejectionReason" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="Enter custom reason"></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="confirmRejectButton" class="bg-red-600 text-white py-2 px-6 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    Confirm Rejection
                </button>
                <button id="cancelRejectButton" class="bg-gray-300 text-gray-800 py-2 px-6 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Adjust Time Modal -->
    <div id="adjustTimeModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 m-4 max-w-md w-full relative">
            <button id="closeAdjustTimeModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h3 class="text-2xl font-bold mb-4 text-green-700 text-center">Approve Appointment</h3>
            <div class="text-gray-700 space-y-4">
                <p>Do you want to adjust the appointment time?</p>
                <div class="flex items-center space-x-4">
                    <input type="radio" id="adjustTimeYes" name="adjustTimeOption" value="yes" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded" />
                    <label for="adjustTimeYes" class="text-sm font-medium text-gray-700">Yes, adjust time</label>
                    <input type="radio" id="adjustTimeNo" name="adjustTimeOption" value="no" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded" checked />
                    <label for="adjustTimeNo" class="text-sm font-medium text-gray-700">No, approve as is</label>
                </div>
                <div id="newTimeContainer" class="hidden mt-4">
                    <label for="newAppointmentTime" class="block text-sm font-medium text-gray-700">Set New Time:</label>
                    <input type="time" id="newAppointmentTime" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" />
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="confirmAdjustedApprovalButton" class="bg-green-600 text-white py-2 px-6 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    Confirm Approval
                </button>
                <button id="cancelAdjustedApprovalButton" class="bg-gray-300 text-gray-800 py-2 px-6 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Checkout Confirmation Modal -->
    <div id="checkoutConfirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 m-4 max-w-sm w-full relative">
            <button id="closeCheckoutConfirmModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h3 class="text-2xl font-bold mb-4 text-red-700 text-center">Confirm Check Out</h3>
            <p class="text-gray-700 text-center mb-6">Are you sure you want to check out this visitor?</p>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="confirmCheckoutButton" class="bg-red-600 text-white py-2 px-6 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    Confirm Check Out
                </button>
                <button id="cancelCheckoutButton" class="bg-gray-300 text-gray-800 py-2 px-6 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    Cancel
                </button>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, updateDoc, getDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances and app state
        let db = null;
        let auth = null;
        let userId = null;
        let userEmail = null; // To store logged-in user's email
        let isAuthReady = false;
        let currentPage = 'principalBooking'; // Default page after login
        let appContent = null; // Declare appContent globally
        let isLoggedIn = false; // Track login state
        let appId = null; // Declare appId globally here

        // Data states (equivalent to React's useState)
        let bookedAppointments = [];
        let pendingApprovals = []; // This will now hold the currently filtered approvals
        let registeredVisitors = []; // Only currently checked-in visitors
        let visitorLogsData = []; // All checked-out visitors
        let message = '';
        let principalApprovalFilter = 'Pending'; // Default filter for principal approval tab

        // To store the unsubscribe function for Firestore listeners
        // Ensure these are initialized to null globally
        let unsubscribePrincipalApprovals = null;
        let unsubscribeRegisteredVisitors = null;
        let unsubscribeVisitorLogs = null;
        let unsubscribeBookedAppointments = null;

        // Variable to store the ID of the appointment currently being rejected
        let currentAppointmentToRejectId = null;
        // Variable to store the ID of the appointment currently being approved/adjusted
        let currentAppointmentToApproveId = null;
        // Variable to store the ID of the visitor currently being checked out
        let currentVisitorToCheckoutId = null;


        // Function to update the message display (for general app messages)
        function updateMessage(msg) {
            message = msg;
            const messageElement = document.getElementById('app-message');
            if (messageElement) {
                messageElement.textContent = message;
                messageElement.className = "mt-4 text-center text-sm font-medium text-green-600"; // Reset class
                if (msg.includes("Error") || msg.includes("Failed")) {
                    messageElement.className = "mt-4 text-center text-sm font-medium text-red-600";
                }
            }
        }

        // Function to update the login screen message
        function updateLoginMessage(msg) {
            const loginMessageElement = document.getElementById('login-message');
            if (loginMessageElement) {
                loginMessageElement.textContent = msg;
            }
        }

        // Function to render the login form
        function renderLoginForm() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-app-content').classList.add('hidden');
            const loginSubmitButton = document.getElementById('loginSubmitButton');
            if (loginSubmitButton) {
                loginSubmitButton.disabled = true; // Disable by default
            }
            updateLoginMessage('App is initializing. Please wait...'); // Set initial message
            // attachLoginEventListeners(); // This is called by DOMContentLoaded
        }

        // Function to render the main application content
        function renderMainApp() {
            console.log("Executing renderMainApp(). Hiding login, showing main content.");
            const loginScreen = document.getElementById('login-screen');
            const mainAppContent = document.getElementById('main-app-content');

            if (loginScreen && mainAppContent) {
                loginScreen.classList.add('hidden');
                mainAppContent.classList.remove('hidden');
                // Update logged-in user email in the navbar
                document.getElementById('loggedInUserEmail').textContent = userEmail || 'User';
                renderContent(); // Render the specific page content
                setupNavListeners(); // Ensure navigation listeners are set up after login
                console.log("UI elements updated. Login screen hidden, main app visible.");
            } else {
                console.error("renderMainApp: Could not find login-screen or main-app-content elements.");
            }
        }

        // Function to render the current page content (within the main app)
        function renderContent() {
            let html = '';

            switch (currentPage) {
                case 'registerVisitor':
                    html = `
                        <div class="p-6 bg-white rounded-lg shadow-md max-w-lg mx-auto">
                            <h2 class="text-2xl font-bold mb-4 text-center text-green-700">Register Visitor</h2>
                            <form id="registerVisitorForm" class="space-y-4">
                                <div>
                                    <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name:</label>
                                    <input type="text" id="fullName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="e.g., Tilen Okoth Kungu" required />
                                </div>
                                <div>
                                    <label for="phoneNumber" class="block text-sm font-medium text-gray-700">Phone Number (e.g., 07XXXXXXXXXX):</label>
                                    <input type="tel" id="phoneNumber" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="e.g., 0712345678" required />
                                    <p class="text-xs text-gray-500 mt-1">Format: 07XXXXXXXXXX or 2547XXXXXXXXXX</p>
                                </div>
                                <div>
                                    <label for="vehicleNumberPlate" class="block text-sm font-medium text-gray-700">Vehicle Number Plate (Optional):</label>
                                    <input type="text" id="vehicleNumberPlate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="e.g., KBC 123X" />
                                </div>
                                <div>
                                    <label for="idNumber" class="block text-sm font-medium text-gray-700">ID Number (National ID/Passport):</label>
                                    <input type="text" id="idNumber" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="e.g., 12345678" required />
                                </div>
                                <div>
                                    <label for="purposeOfVisit" class="block text-sm font-medium text-gray-700">Purpose of Visit:</label>
                                    <select id="purposeOfVisit" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" required>
                                        <option value="">-- Select Purpose --</option>
                                        <option value="Meeting">Meeting</option>
                                        <option value="Delivery">Delivery</option>
                                        <option value="Interview">Interview</option>
                                        <option value="Maintenance">Maintenance</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="hostNameDepartment" class="block text-sm font-medium text-gray-700">Host Name / Department (Optional):</label>
                                    <input type="text" id="hostNameDepartment" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="e.g., Dean of Studies Office" />
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="dataPrivacyTerms" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded" required />
                                    <label for="dataPrivacyTerms" class="ml-2 block text-sm text-gray-900">I agree to the <a href="#" id="showPrivacyTerms" class="text-blue-600 hover:underline">data privacy terms</a>.</label>
                                </div>
                                <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                                    Register Visitor
                                </button>
                            </form>
                            <div class="mt-6">
                                <h3 class="text-xl font-semibold mb-3 text-green-700">Registered Visitors:</h3>
                                <div id="registeredVisitorsList" class="space-y-2">
                                    ${registeredVisitors.length === 0 ? '<p class="text-gray-600">No visitors registered yet.</p>' :
                                        registeredVisitors.map(visitor => `
                                            <div class="bg-gray-50 p-3 rounded-md shadow-sm flex justify-between items-center">
                                                <span>${visitor.name} - Vehicle: <span class="font-semibold">${visitor.vehiclePlate || 'N/A'}</span></span>
                                            </div>
                                        `).join('')
                                    }
                                </div>
                            </div>
                            <p id="app-message" class="mt-4 text-center text-sm font-medium text-green-600"></p>
                        </div>
                    `;
                    break;
                case 'principalBooking':
                    html = `
                        <div class="p-6 bg-white rounded-lg shadow-md max-w-lg mx-auto">
                            <h2 class="text-2xl font-bold mb-4 text-center text-green-700">Book Principal Appointment</h2>
                            <form id="bookAppointmentForm" class="space-y-4">
                                <div>
                                    <label for="name" class="block text-sm font-medium text-gray-700">Your Name:</label>
                                    <input type="text" id="name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="e.g., Tilen Kungu" required />
                                </div>
                                <div>
                                    <label for="email" class="block text-sm font-medium text-gray-700">Your Email:</label>
                                    <input type="email" id="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="e.g., name@example.com" required />
                                </div>
                                <div>
                                    <label for="idNumberBooking" class="block text-sm font-medium text-gray-700">Your ID Number:</label>
                                    <input type="text" id="idNumberBooking" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="e.g., 12345678" required />
                                </div>
                                <div>
                                    <label for="phone" class="block text-sm font-medium text-gray-700">Your Phone Number:</label>
                                    <input type="tel" id="phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="e.g., 07XXXXXXXXXX or +254XXXXXXXXX" required />
                                </div>
                                <div>
                                    <label for="purpose" class="block text-sm font-medium text-gray-700">Purpose of Meeting:</label>
                                    <textarea id="purpose" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" required></textarea>
                                </div>
                                <div>
                                    <label for="date" class="block text-sm font-medium text-gray-700">Desired Date:</label>
                                    <input type="date" id="date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" required />
                                </div>
                                <div>
                                    <label for="time" class="block text-sm font-medium text-gray-700">Desired Time:</label>
                                    <input type="time" id="time" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" required />
                                </div>
                                <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                                    Book Appointment
                                </button>
                            </form>
                            <p id="app-message" class="mt-4 text-center text-sm font-medium text-green-600"></p>

                            <div class="mt-6">
                                <h3 class="text-xl font-semibold mb-3 text-green-700">Your Booked Appointments:</h3>
                                <div id="bookedAppointmentsList" class="space-y-2">
                                    ${bookedAppointments.length === 0 ? '<p class="text-gray-600">No appointments booked yet.</p>' :
                                        bookedAppointments.map(appointment => `
                                            <div class="bg-gray-50 p-3 rounded-md shadow-sm flex justify-between items-center">
                                                <span>${appointment.name} - ${appointment.date} ${appointment.time} (<span class="${appointment.status === 'Pending' ? 'text-yellow-700' : appointment.status === 'Approved' ? 'text-green-700' : 'text-red-700'}">${appointment.status}</span>)</span>
                                            </div>
                                        `).join('')
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'principalApproval':
                    html = `
                        <div id="principalApprovalContainer" class="p-6 bg-white rounded-lg shadow-md max-w-2xl mx-auto">
                            <h2 class="text-2xl font-bold mb-4 text-center text-green-700">Principal Approval Dashboard</h2>
                            <div class="flex justify-center space-x-4 mb-4">
                                <button data-filter="Pending" class="filter-btn py-2 px-4 rounded-md transition duration-300 ease-in-out ${principalApprovalFilter === 'Pending' ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                                    Pending
                                </button>
                                <button data-filter="Approved" class="filter-btn py-2 px-4 rounded-md transition duration-300 ease-in-out ${principalApprovalFilter === 'Approved' ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                                    Approved
                                </button>
                                <button data-filter="Rejected" class="filter-btn py-2 px-4 rounded-md transition duration-300 ease-in-out ${principalApprovalFilter === 'Rejected' ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                                    Rejected
                                </button>
                                <button data-filter="All" class="filter-btn py-2 px-4 rounded-md transition duration-300 ease-in-out ${principalApprovalFilter === 'All' ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                                    All
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                                    <thead>
                                        <tr class="bg-green-100 text-green-800 uppercase text-sm leading-normal">
                                            <th class="py-3 px-6 text-left">Visitor Name</th>
                                            <th class="py-3 px-6 text-left">Purpose</th>
                                            <th class="py-3 px-6 text-left">Date</th>
                                            <th class="py-3 px-6 text-left">Time</th>
                                            <th class="py-3 px-6 text-left">Status</th>
                                            <th class="py-3 px-6 text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-gray-700 text-sm font-light">
                                        ${pendingApprovals.length === 0 ? `
                                            <tr>
                                                <td colspan="6" class="py-3 px-6 text-center text-gray-600">No ${principalApprovalFilter.toLowerCase()} appointments.</td>
                                            </tr>
                                        ` :
                                        pendingApprovals.map(appointment => `
                                            <tr class="border-b border-gray-200 hover:bg-gray-100">
                                                <td class="py-3 px-6 text-left whitespace-nowrap">${appointment.name}</td>
                                                <td class="py-3 px-6 text-left">${appointment.purpose}</td>
                                                <td class="py-3 px-6 text-left">${appointment.date}</td>
                                                <td class="py-3 px-6 text-left">${appointment.time}</td>
                                                <td class="py-3 px-6 text-left">
                                                    <span class="py-1 px-3 rounded-full text-xs font-semibold ${appointment.status === 'Pending' ? 'bg-yellow-200 text-yellow-800' : appointment.status === 'Approved' ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">
                                                        ${appointment.status}
                                                    </span>
                                                </td>
                                                <td class="py-3 px-6 text-center">
                                                    <div class="flex item-center justify-center space-x-2">
                                                        ${appointment.status === 'Pending' ? `
                                                            <button data-id="${appointment.id}" class="approve-btn bg-green-500 text-white py-1 px-3 rounded-md text-xs hover:bg-green-600 transition duration-150 ease-in-out">Approve</button>
                                                            <button data-id="${appointment.id}" class="reject-btn bg-red-500 text-white py-1 px-3 rounded-md text-xs hover:bg-red-600 transition duration-150 ease-in-out">Reject</button>
                                                        ` : `
                                                            <span class="text-gray-500 text-xs">No actions</span>
                                                        `}
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')
                                    }
                                    </tbody>
                                </table>
                            </div>
                            <p id="app-message" class="mt-4 text-center text-sm font-medium text-green-600"></p>
                        </div>
                    `;
                    break;
                case 'dashboard':
                    html = `
                        <div class="p-6 bg-white rounded-lg shadow-md max-w-4xl mx-auto">
                            <h2 class="text-2xl font-bold mb-4 text-center text-green-700">Dashboard Overview</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div class="bg-blue-100 p-4 rounded-lg shadow-sm text-center">
                                    <p class="text-3xl font-bold text-blue-700">${registeredVisitors.length}</p>
                                    <p class="text-blue-800">Currently Checked-In</p>
                                </div>
                                <div class="bg-yellow-100 p-4 rounded-lg shadow-sm text-center">
                                    <p class="text-3xl font-bold text-yellow-700">${bookedAppointments.filter(app => app.status === 'Pending').length}</p>
                                    <p class="text-yellow-800">Pending Approvals</p>
                                </div>
                                <div class="bg-green-100 p-4 rounded-lg shadow-sm text-center">
                                    <p class="text-3xl font-bold text-green-700">${visitorLogsData.length}</p>
                                    <p class="text-green-800">Total Checked-Out</p>
                                </div>
                            </div>

                            <div class="mt-8">
                                <h3 class="text-xl font-semibold mb-3 text-green-700">Recent Activity:</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                                        <thead>
                                            <tr class="bg-gray-100 text-gray-700 uppercase text-xs leading-normal">
                                                <th class="py-3 px-6 text-left">Visitor Name</th>
                                                <th class="py-3 px-6 text-left">Purpose</th>
                                                <th class="py-3 px-6 text-left">Check-in Time</th>
                                                <th class="py-3 px-6 text-left">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody class="text-gray-700 text-sm font-light">
                                            ${[...registeredVisitors, ...visitorLogsData].sort((a, b) => new Date(b.checkInTime) - new Date(a.checkInTime)).slice(0, 5).length === 0 ? `
                                                <tr>
                                                    <td colspan="4" class="py-3 px-6 text-center text-gray-600">No recent activity.</td>
                                                </tr>
                                            ` :
                                            [...registeredVisitors, ...visitorLogsData].sort((a, b) => new Date(b.checkInTime) - new Date(a.checkInTime)).slice(0, 5).map(item => `
                                                <tr class="border-b border-gray-200 hover:bg-gray-100">
                                                    <td class="py-3 px-6 text-left whitespace-nowrap">${item.name}</td>
                                                    <td class="py-3 px-6 text-left">${item.purposeOfVisit || item.purpose}</td>
                                                    <td class="py-3 px-6 text-left">${new Date(item.checkInTime).toLocaleString()}</td>
                                                    <td class="py-3 px-6 text-left">
                                                        <span class="py-1 px-3 rounded-full text-xs font-semibold ${item.checkOutTime ? 'bg-gray-200 text-gray-800' : 'bg-blue-200 text-blue-800'}">
                                                            ${item.checkOutTime ? 'Checked Out' : 'Checked In'}
                                                        </span>
                                                    </td>
                                                </tr>
                                            `).join('')
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <p id="app-message" class="mt-4 text-center text-sm font-medium text-green-600"></p>
                        </div>
                    `;
                    break;
                case 'visitorLogs':
                    html = `
                        <div class="p-6 bg-white rounded-lg shadow-md max-w-4xl mx-auto">
                            <h2 class="text-2xl font-bold mb-4 text-center text-green-700">Visitor Logs</h2>
                            <div class="mb-4 flex flex-wrap gap-4">
                                <input type="text" id="logSearchName" placeholder="Search by name" class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" />
                                <input type="text" id="logSearchId" placeholder="Search by ID" class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" />
                                <input type="date" id="logSearchDate" class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" />
                                <button id="clearLogFilters" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-150 ease-in-out">Clear Filters</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                                    <thead>
                                        <tr class="bg-green-100 text-green-800 uppercase text-sm leading-normal">
                                            <th class="py-3 px-6 text-left">Name</th>
                                            <th class="py-3 px-6 text-left">ID No.</th>
                                            <th class="py-3 px-6 text-left">Purpose</th>
                                            <th class="py-3 px-6 text-left">Check-in</th>
                                            <th class="py-3 px-6 text-left">Check-out</th>
                                            <th class="py-3 px-6 text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="visitorLogsTableBody" class="text-gray-700 text-sm font-light">
                                        ${visitorLogsData.length === 0 && registeredVisitors.length === 0 ? `
                                            <tr>
                                                <td colspan="6" class="py-3 px-6 text-center text-gray-600">No visitor records found.</td>
                                            </tr>
                                        ` :
                                        [...registeredVisitors, ...visitorLogsData].sort((a, b) => new Date(b.checkInTime) - new Date(a.checkInTime)).map(visitor => `
                                            <tr class="border-b border-gray-200 hover:bg-gray-100">
                                                <td class="py-3 px-6 text-left whitespace-nowrap">${visitor.name}</td>
                                                <td class="py-3 px-6 text-left">${visitor.idNumber}</td>
                                                <td class="py-3 px-6 text-left">${visitor.purposeOfVisit || visitor.purpose}</td>
                                                <td class="py-3 px-6 text-left">${new Date(visitor.checkInTime).toLocaleString()}</td>
                                                <td class="py-3 px-6 text-left">${visitor.checkOutTime ? new Date(visitor.checkOutTime).toLocaleString() : '<span class="text-blue-600">Still In</span>'}</td>
                                                <td class="py-3 px-6 text-center">
                                                    ${!visitor.checkOutTime ? `
                                                        <button data-id="${visitor.id}" class="checkout-btn bg-red-500 text-white py-1 px-3 rounded-md text-xs hover:bg-red-600 transition duration-150 ease-in-out">Check Out</button>
                                                    ` : `
                                                        <span class="text-gray-500 text-xs">Checked Out</span>
                                                    `}
                                                </td>
                                            </tr>
                                        `).join('')
                                        }
                                    </tbody>
                                </table>
                            </div>
                            <p id="app-message" class="mt-4 text-center text-sm font-medium text-green-600"></p>
                        </div>
                    `;
                    break;
                case 'createStaffUser':
                    html = `
                        <div class="p-6 bg-white rounded-lg shadow-md max-w-md mx-auto">
                            <h2 class="text-2xl font-bold mb-4 text-center text-green-700">Create Staff User</h2>
                            <form id="createStaffUserForm" class="space-y-4">
                                <div>
                                    <label for="staffEmail" class="block text-sm font-medium text-gray-700">Staff Email:</label>
                                    <input type="email" id="staffEmail" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="staff@knp.ac.ke" required />
                                </div>
                                <div>
                                    <label for="staffPassword" class="block text-sm font-medium text-gray-700">Password:</label>
                                    <input type="password" id="staffPassword" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" required />
                                </div>
                                <div>
                                    <label for="staffRole" class="block text-sm font-medium text-gray-700">Role:</label>
                                    <select id="staffRole" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" required>
                                        <option value="">-- Select Role --</option>
                                        <option value="Admin">Admin</option>
                                        <option value="Receptionist">Receptionist</option>
                                        <option value="Principal">Principal</option>
                                    </select>
                                </div>
                                <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                                    Create User
                                </button>
                            </form>
                            <p id="app-message" class="mt-4 text-center text-sm font-medium text-green-600"></p>
                        </div>
                    `;
                    break;
                default:
                    html = `<div class="text-center text-gray-600">Welcome to KNP Visitor Management System. Please select an option from the navigation.</div>`;
            }
            appContent.innerHTML = html;
            attachPageSpecificEventListeners();
            updateMessage(''); // Clear message when page content changes
        }

        // --- Event Listeners and Handlers ---

        function attachLoginEventListeners() {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.onsubmit = async (e) => {
                    e.preventDefault();
                    // This check is now primarily for user experience, as the button should be disabled
                    if (!isAuthReady || !auth) {
                        updateLoginMessage('App is still initializing. Please wait a moment and try again.');
                        console.warn("Login attempt before Firebase Auth is fully ready.");
                        return;
                    }

                    const email = document.getElementById('loginEmail').value;
                    const password = document.getElementById('loginPassword').value;
                    updateLoginMessage('Logging in...');
                    try {
                        const userCredential = await signInWithEmailAndPassword(auth, email, password);
                        console.log("Logged in successfully:", userCredential.user.email);
                        userEmail = userCredential.user.email;
                        userId = userCredential.user.uid;
                        isLoggedIn = true;
                        renderMainApp();
                    } catch (error) {
                        console.error("Login error:", error);
                        updateLoginMessage(`Login failed: ${error.message}`);
                    }
                };
            }
        }

        function setupNavListeners() {
            const hamburgerButton = document.getElementById('hamburger-button');
            const navLinksContainer = document.getElementById('nav-links-container');
            const logoutButton = document.getElementById('logoutButton');

            if (hamburgerButton) {
                hamburgerButton.onclick = () => {
                    navLinksContainer.classList.toggle('hidden');
                    navLinksContainer.classList.toggle('flex');
                };
            }

            if (logoutButton) {
                logoutButton.onclick = async () => {
                    try {
                        await signOut(auth);
                        console.log("User signed out.");
                        isLoggedIn = false;
                        userId = null;
                        userEmail = null;
                        unsubscribeAllFirestoreListeners(); // Unsubscribe before logging out
                        renderLoginForm();
                    } catch (error) {
                        console.error("Logout error:", error);
                        updateMessage(`Logout failed: ${error.message}`);
                    }
                };
            }

            // Attach listeners to navigation buttons
            document.getElementById('navRegisterVisitor').onclick = () => { currentPage = 'registerVisitor'; renderContent(); navLinksContainer.classList.add('hidden'); navLinksContainer.classList.remove('flex'); };
            document.getElementById('navPrincipalBooking').onclick = () => { currentPage = 'principalBooking'; renderContent(); navLinksContainer.classList.add('hidden'); navLinksContainer.classList.remove('flex'); };
            document.getElementById('navPrincipalApproval').onclick = () => { currentPage = 'principalApproval'; renderContent(); navLinksContainer.classList.add('hidden'); navLinksContainer.classList.remove('flex'); };
            document.getElementById('navDashboard').onclick = () => { currentPage = 'dashboard'; renderContent(); navLinksContainer.classList.add('hidden'); navLinksContainer.classList.remove('flex'); };
            document.getElementById('navVisitorLogs').onclick = () => { currentPage = 'visitorLogs'; renderContent(); navLinksContainer.classList.add('hidden'); navLinksContainer.classList.remove('flex'); };
            document.getElementById('navCreateStaffUser').onclick = () => { currentPage = 'createStaffUser'; renderContent(); navLinksContainer.classList.add('hidden'); navLinksContainer.classList.remove('flex'); };

            // Show user ID for multi-user identification (if needed for debugging)
            const userIdDisplay = document.getElementById('user-id-display');
            const currentUserIdSpan = document.getElementById('current-user-id');
            if (userIdDisplay && currentUserIdSpan) {
                currentUserIdSpan.textContent = userId;
                // userIdDisplay.classList.remove('hidden'); // Uncomment to show user ID
            }
        }

        function attachPageSpecificEventListeners() {
            if (currentPage === 'registerVisitor') {
                const registerVisitorForm = document.getElementById('registerVisitorForm');
                const showPrivacyTermsLink = document.getElementById('showPrivacyTerms');
                const privacyModal = document.getElementById('privacyModal');
                const modalCloseButton = document.getElementById('modalCloseButton');
                const closePrivacyModalButton = document.getElementById('closePrivacyModal');

                if (registerVisitorForm) {
                    registerVisitorForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const fullName = document.getElementById('fullName').value;
                        const phoneNumber = document.getElementById('phoneNumber').value;
                        const vehicleNumberPlate = document.getElementById('vehicleNumberPlate').value;
                        const idNumber = document.getElementById('idNumber').value;
                        const purposeOfVisit = document.getElementById('purposeOfVisit').value;
                        const hostNameDepartment = document.getElementById('hostNameDepartment').value;
                        const checkInTime = new Date().toISOString();

                        updateMessage('Registering visitor...');

                        try {
                            // Add visitor to 'registeredVisitors' collection
                            await addDoc(collection(db, `artifacts/${appId}/public/data/registeredVisitors`), {
                                name: fullName,
                                phoneNumber: phoneNumber,
                                vehiclePlate: vehicleNumberPlate,
                                idNumber: idNumber,
                                purposeOfVisit: purposeOfVisit,
                                hostNameDepartment: hostNameDepartment,
                                checkInTime: checkInTime,
                                checkOutTime: null, // Initially null
                                registeredBy: userEmail,
                                registeredById: userId
                            });
                            updateMessage('Visitor registered successfully!');
                            registerVisitorForm.reset(); // Clear form
                        } catch (error) {
                            console.error("Error registering visitor:", error);
                            updateMessage(`Error registering visitor: ${error.message}`);
                        }
                    };
                }

                if (showPrivacyTermsLink) {
                    showPrivacyTermsLink.onclick = (e) => {
                        e.preventDefault();
                        privacyModal.classList.remove('hidden');
                    };
                }
                if (modalCloseButton) {
                    modalCloseButton.onclick = () => {
                        privacyModal.classList.add('hidden');
                    };
                }
                if (closePrivacyModalButton) {
                    closePrivacyModalButton.onclick = () => {
                        privacyModal.classList.add('hidden');
                    };
                }
            } else if (currentPage === 'principalBooking') {
                const bookAppointmentForm = document.getElementById('bookAppointmentForm');
                if (bookAppointmentForm) {
                    bookAppointmentForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const name = document.getElementById('name').value;
                        const email = document.getElementById('email').value;
                        const idNumberBooking = document.getElementById('idNumberBooking').value;
                        const phone = document.getElementById('phone').value;
                        const purpose = document.getElementById('purpose').value;
                        const date = document.getElementById('date').value;
                        const time = document.getElementById('time').value;
                        const requestedAt = new Date().toISOString();

                        updateMessage('Booking appointment...');

                        try {
                            await addDoc(collection(db, `artifacts/${appId}/public/data/principalAppointments`), {
                                name,
                                email,
                                idNumber: idNumberBooking,
                                phone,
                                purpose,
                                date,
                                time,
                                status: 'Pending', // Initial status
                                requestedBy: userEmail,
                                requestedById: userId,
                                requestedAt: requestedAt
                            });
                            updateMessage('Appointment booked successfully! Awaiting principal approval.');
                            bookAppointmentForm.reset(); // Clear form
                        } catch (error) {
                            console.error("Error booking appointment:", error);
                            updateMessage(`Error booking appointment: ${error.message}`);
                        }
                    };
                }
            } else if (currentPage === 'principalApproval') {
                const filterButtons = document.querySelectorAll('.filter-btn');
                filterButtons.forEach(button => {
                    button.onclick = (e) => {
                        principalApprovalFilter = e.target.dataset.filter;
                        updatePrincipalApprovals(); // Re-fetch/filter data based on new filter
                        renderContent(); // Re-render the page to update button active state
                    };
                });

                // Attach event listeners for Approve/Reject buttons (delegation)
                const principalApprovalContainer = document.getElementById('principalApprovalContainer');
                if (principalApprovalContainer) {
                    principalApprovalContainer.onclick = (e) => {
                        if (e.target.classList.contains('approve-btn')) {
                            currentAppointmentToApproveId = e.target.dataset.id;
                            document.getElementById('adjustTimeModal').classList.remove('hidden');
                        } else if (e.target.classList.contains('reject-btn')) {
                            currentAppointmentToRejectId = e.target.dataset.id;
                            document.getElementById('rejectReasonModal').classList.remove('hidden');
                        }
                    };
                }

                // Reject Reason Modal Logic
                const rejectionReasonSelect = document.getElementById('rejectionReasonSelect');
                const customReasonContainer = document.getElementById('customReasonContainer');
                const customRejectionReason = document.getElementById('customRejectionReason');
                const confirmRejectButton = document.getElementById('confirmRejectButton');
                const cancelRejectButton = document.getElementById('cancelRejectButton');
                const closeRejectReasonModalButton = document.getElementById('closeRejectReasonModal');

                if (rejectionReasonSelect) {
                    rejectionReasonSelect.onchange = () => {
                        if (rejectionReasonSelect.value === 'Other') {
                            customReasonContainer.classList.remove('hidden');
                            customRejectionReason.setAttribute('required', 'true');
                        } else {
                            customReasonContainer.classList.add('hidden');
                            customRejectionReason.removeAttribute('required');
                            customRejectionReason.value = '';
                        }
                    };
                }

                if (confirmRejectButton) {
                    confirmRejectButton.onclick = async () => {
                        let reason = rejectionReasonSelect.value;
                        if (reason === 'Other') {
                            reason = customRejectionReason.value.trim();
                            if (!reason) {
                                updateMessage('Please enter a custom rejection reason.');
                                return;
                            }
                        }
                        if (!reason) {
                            updateMessage('Please select or enter a rejection reason.');
                            return;
                        }

                        if (currentAppointmentToRejectId && db) {
                            try {
                                const docRef = doc(db, `artifacts/${appId}/public/data/principalAppointments`, currentAppointmentToRejectId);
                                await updateDoc(docRef, {
                                    status: 'Rejected',
                                    rejectionReason: reason,
                                    approvedBy: userEmail,
                                    approvedById: userId,
                                    approvedAt: new Date().toISOString()
                                });
                                updateMessage('Appointment rejected successfully.');
                                document.getElementById('rejectReasonModal').classList.add('hidden');
                                currentAppointmentToRejectId = null;
                                rejectionReasonSelect.value = '';
                                customRejectionReason.value = '';
                                customReasonContainer.classList.add('hidden');
                            } catch (error) {
                                console.error("Error rejecting appointment:", error);
                                updateMessage(`Error rejecting appointment: ${error.message}`);
                            }
                        }
                    };
                }

                if (cancelRejectButton) {
                    cancelRejectButton.onclick = () => {
                        document.getElementById('rejectReasonModal').classList.add('hidden');
                        currentAppointmentToRejectId = null;
                        rejectionReasonSelect.value = '';
                        customRejectionReason.value = '';
                        customReasonContainer.classList.add('hidden');
                    };
                }

                if (closeRejectReasonModalButton) {
                    closeRejectReasonModalButton.onclick = () => {
                        document.getElementById('rejectReasonModal').classList.add('hidden');
                        currentAppointmentToRejectId = null;
                        rejectionReasonSelect.value = '';
                        customRejectionReason.value = '';
                        customReasonContainer.classList.add('hidden');
                    };
                }

                // Adjust Time Modal Logic
                const adjustTimeYes = document.getElementById('adjustTimeYes');
                const adjustTimeNo = document.getElementById('adjustTimeNo');
                const newTimeContainer = document.getElementById('newTimeContainer');
                const newAppointmentTime = document.getElementById('newAppointmentTime');
                const confirmAdjustedApprovalButton = document.getElementById('confirmAdjustedApprovalButton');
                const cancelAdjustedApprovalButton = document.getElementById('cancelAdjustedApprovalButton');
                const closeAdjustTimeModalButton = document.getElementById('closeAdjustTimeModal');

                if (adjustTimeYes) {
                    adjustTimeYes.onchange = () => {
                        if (adjustTimeYes.checked) {
                            newTimeContainer.classList.remove('hidden');
                            newAppointmentTime.setAttribute('required', 'true');
                        }
                    };
                }

                if (adjustTimeNo) {
                    adjustTimeNo.onchange = () => {
                        if (adjustTimeNo.checked) {
                            newTimeContainer.classList.add('hidden');
                            newAppointmentTime.removeAttribute('required');
                            newAppointmentTime.value = '';
                        }
                    };
                }

                if (confirmAdjustedApprovalButton) {
                    confirmAdjustedApprovalButton.onclick = async () => {
                        let updatedTime = null;
                        if (adjustTimeYes.checked) {
                            updatedTime = newAppointmentTime.value.trim();
                            if (!updatedTime) {
                                updateMessage('Please set a new appointment time.');
                                return;
                            }
                        }

                        if (currentAppointmentToApproveId && db) {
                            try {
                                const docRef = doc(db, `artifacts/${appId}/public/data/principalAppointments`, currentAppointmentToApproveId);
                                const updateData = {
                                    status: 'Approved',
                                    approvedBy: userEmail,
                                    approvedById: userId,
                                    approvedAt: new Date().toISOString()
                                };
                                if (updatedTime) {
                                    updateData.time = updatedTime;
                                }
                                await updateDoc(docRef, updateData);
                                updateMessage('Appointment approved successfully.');
                                document.getElementById('adjustTimeModal').classList.add('hidden');
                                currentAppointmentToApproveId = null;
                                adjustTimeNo.checked = true; // Reset radio button
                                newTimeContainer.classList.add('hidden');
                                newAppointmentTime.value = '';
                            } catch (error) {
                                console.error("Error approving appointment:", error);
                                updateMessage(`Error approving appointment: ${error.message}`);
                            }
                        }
                    };
                }

                if (cancelAdjustedApprovalButton) {
                    cancelAdjustedApprovalButton.onclick = () => {
                        document.getElementById('adjustTimeModal').classList.add('hidden');
                        currentAppointmentToApproveId = null;
                        adjustTimeNo.checked = true; // Reset radio button
                        newTimeContainer.classList.add('hidden');
                        newAppointmentTime.value = '';
                    };
                }

                if (closeAdjustTimeModalButton) {
                    closeAdjustTimeModalButton.onclick = () => {
                        document.getElementById('adjustTimeModal').classList.add('hidden');
                        currentAppointmentToApproveId = null;
                        adjustTimeNo.checked = true; // Reset radio button
                        newTimeContainer.classList.add('hidden');
                        newAppointmentTime.value = '';
                    };
                }

            } else if (currentPage === 'visitorLogs') {
                const logSearchName = document.getElementById('logSearchName');
                const logSearchId = document.getElementById('logSearchId');
                const logSearchDate = document.getElementById('logSearchDate');
                const clearLogFilters = document.getElementById('clearLogFilters');

                const applyFilters = () => {
                    let filteredLogs = [...registeredVisitors, ...visitorLogsData]; // Combine all for search

                    const nameFilter = logSearchName.value.toLowerCase();
                    const idFilter = logSearchId.value.toLowerCase();
                    const dateFilter = logSearchDate.value; // YYYY-MM-DD

                    if (nameFilter) {
                        filteredLogs = filteredLogs.filter(log => log.name.toLowerCase().includes(nameFilter));
                    }
                    if (idFilter) {
                        filteredLogs = filteredLogs.filter(log => log.idNumber.toLowerCase().includes(idFilter));
                    }
                    if (dateFilter) {
                        filteredLogs = filteredLogs.filter(log => {
                            const checkInDate = new Date(log.checkInTime).toISOString().split('T')[0];
                            return checkInDate === dateFilter;
                        });
                    }

                    // Sort by check-in time descending
                    filteredLogs.sort((a, b) => new Date(b.checkInTime) - new Date(a.checkInTime));

                    // Re-render the table body with filtered data
                    const tableBody = document.getElementById('visitorLogsTableBody');
                    if (tableBody) {
                        tableBody.innerHTML = filteredLogs.length === 0 ? `
                            <tr>
                                <td colspan="6" class="py-3 px-6 text-center text-gray-600">No matching visitor records found.</td>
                            </tr>
                        ` :
                        filteredLogs.map(visitor => `
                            <tr class="border-b border-gray-200 hover:bg-gray-100">
                                <td class="py-3 px-6 text-left whitespace-nowrap">${visitor.name}</td>
                                <td class="py-3 px-6 text-left">${visitor.idNumber}</td>
                                <td class="py-3 px-6 text-left">${visitor.purposeOfVisit || visitor.purpose}</td>
                                <td class="py-3 px-6 text-left">${new Date(visitor.checkInTime).toLocaleString()}</td>
                                <td class="py-3 px-6 text-left">${visitor.checkOutTime ? new Date(visitor.checkOutTime).toLocaleString() : '<span class="text-blue-600">Still In</span>'}</td>
                                <td class="py-3 px-6 text-center">
                                    ${!visitor.checkOutTime ? `
                                        <button data-id="${visitor.id}" class="checkout-btn bg-red-500 text-white py-1 px-3 rounded-md text-xs hover:bg-red-600 transition duration-150 ease-in-out">Check Out</button>
                                    ` : `
                                        <span class="text-gray-500 text-xs">Checked Out</span>
                                    `}
                                </td>
                            </tr>
                        `).join('');
                    }
                };

                logSearchName.oninput = applyFilters;
                logSearchId.oninput = applyFilters;
                logSearchDate.onchange = applyFilters; // Use onchange for date input

                if (clearLogFilters) {
                    clearLogFilters.onclick = () => {
                        logSearchName.value = '';
                        logSearchId.value = '';
                        logSearchDate.value = '';
                        applyFilters(); // Apply filters to show all again
                    };
                }

                // Checkout Confirmation Modal Logic
                const checkoutConfirmModal = document.getElementById('checkoutConfirmModal');
                const confirmCheckoutButton = document.getElementById('confirmCheckoutButton');
                const cancelCheckoutButton = document.getElementById('cancelCheckoutButton');
                const closeCheckoutConfirmModalButton = document.getElementById('closeCheckoutConfirmModal');

                // Event delegation for checkout buttons
                const visitorLogsTableBody = document.getElementById('visitorLogsTableBody');
                if (visitorLogsTableBody) {
                    visitorLogsTableBody.onclick = (e) => {
                        if (e.target.classList.contains('checkout-btn')) {
                            currentVisitorToCheckoutId = e.target.dataset.id;
                            checkoutConfirmModal.classList.remove('hidden');
                        }
                    };
                }

                if (confirmCheckoutButton) {
                    confirmCheckoutButton.onclick = async () => {
                        if (currentVisitorToCheckoutId && db) {
                            try {
                                const docRef = doc(db, `artifacts/${appId}/public/data/registeredVisitors`, currentVisitorToCheckoutId);
                                const visitorDoc = await getDoc(docRef);

                                if (visitorDoc.exists()) {
                                    const visitorData = visitorDoc.data();
                                    const checkOutTime = new Date().toISOString();

                                    // Move to visitorLogs collection
                                    await addDoc(collection(db, `artifacts/${appId}/public/data/visitorLogs`), {
                                        ...visitorData,
                                        checkOutTime: checkOutTime,
                                        checkedOutBy: userEmail,
                                        checkedOutById: userId
                                    });

                                    // Delete from registeredVisitors
                                    await deleteDoc(docRef);
                                    updateMessage('Visitor checked out successfully!');
                                } else {
                                    updateMessage('Visitor not found for checkout.');
                                }
                                checkoutConfirmModal.classList.add('hidden');
                                currentVisitorToCheckoutId = null;
                            } catch (error) {
                                console.error("Error checking out visitor:", error);
                                updateMessage(`Error checking out visitor: ${error.message}`);
                            }
                        }
                    };
                }

                if (cancelCheckoutButton) {
                    cancelCheckoutButton.onclick = () => {
                        checkoutConfirmModal.classList.add('hidden');
                        currentVisitorToCheckoutId = null;
                    };
                }

                if (closeCheckoutConfirmModalButton) {
                    closeCheckoutConfirmModalButton.onclick = () => {
                        checkoutConfirmModal.classList.add('hidden');
                        currentVisitorToCheckoutId = null;
                    };
                }

            } else if (currentPage === 'createStaffUser') {
                const createStaffUserForm = document.getElementById('createStaffUserForm');
                if (createStaffUserForm) {
                    createStaffUserForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const staffEmail = document.getElementById('staffEmail').value;
                        const staffPassword = document.getElementById('staffPassword').value;
                        const staffRole = document.getElementById('staffRole').value;

                        updateMessage('Creating staff user...');

                        try {
                            // In a real application, user creation (especially with custom roles)
                            // should be done via a secure backend (e.g., Firebase Cloud Functions)
                            // using the Firebase Admin SDK to ensure security.
                            // Directly creating users in client-side code is not recommended for production.

                            // For this client-side demo, we'll simulate user creation
                            // and store their role in Firestore.
                            // The actual Firebase Authentication user would need to be created
                            // by an Admin SDK call from a trusted environment.

                            // First, check if a user with this email already exists in Auth
                            // This check is difficult client-side without exposing too much.
                            // A better approach is to try to create, and handle the error.

                            // Store user profile in Firestore (public data for roles)
                            const userProfileRef = doc(db, `artifacts/${appId}/public/data/staffRoles`, staffEmail.replace(/\./g, '_')); // Use email as doc ID, sanitize dots
                            await setDoc(userProfileRef, {
                                email: staffEmail,
                                role: staffRole,
                                createdAt: new Date().toISOString(),
                                createdBy: userEmail,
                                createdById: userId
                            });

                            updateMessage(`Staff user ${staffEmail} with role ${staffRole} created successfully! (Note: Actual Auth user creation requires backend).`);
                            createStaffUserForm.reset();
                        } catch (error) {
                            console.error("Error creating staff user:", error);
                            updateMessage(`Error creating staff user: ${error.message}`);
                        }
                    };
                }
            }
        }

        // --- Firestore Listeners ---

        function setupFirestoreListeners() {
            if (!db || !isAuthReady) {
                console.log("Firestore or Auth not ready, skipping listener setup.");
                return;
            }

            // Unsubscribe existing listeners to prevent duplicates
            unsubscribeAllFirestoreListeners();

            // Listener for 'principalAppointments' (for Principal Booking and Principal Approval)
            const principalAppointmentsColRef = collection(db, `artifacts/${appId}/public/data/principalAppointments`);
            unsubscribeBookedAppointments = onSnapshot(principalAppointmentsColRef, (snapshot) => {
                bookedAppointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Fetched bookedAppointments:", bookedAppointments);
                // Filter approvals based on current filter state
                updatePrincipalApprovals();
                if (currentPage === 'principalBooking' || currentPage === 'principalApproval' || currentPage === 'dashboard') {
                    renderContent(); // Re-render if on relevant pages
                }
            }, (error) => {
                console.error("Error fetching principal appointments:", error);
                updateMessage(`Error fetching appointments: ${error.message}`);
            });

            // Listener for 'registeredVisitors' (for Register Visitor and Visitor Logs)
            const registeredVisitorsColRef = collection(db, `artifacts/${appId}/public/data/registeredVisitors`);
            unsubscribeRegisteredVisitors = onSnapshot(registeredVisitorsColRef, (snapshot) => {
                registeredVisitors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Fetched registeredVisitors:", registeredVisitors);
                if (currentPage === 'registerVisitor' || currentPage === 'visitorLogs' || currentPage === 'dashboard') {
                    renderContent(); // Re-render if on relevant pages
                }
            }, (error) => {
                console.error("Error fetching registered visitors:", error);
                updateMessage(`Error fetching registered visitors: ${error.message}`);
            });

            // Listener for 'visitorLogs' (for Visitor Logs)
            const visitorLogsColRef = collection(db, `artifacts/${appId}/public/data/visitorLogs`);
            unsubscribeVisitorLogs = onSnapshot(visitorLogsColRef, (snapshot) => {
                visitorLogsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Fetched visitorLogsData:", visitorLogsData);
                if (currentPage === 'visitorLogs' || currentPage === 'dashboard') {
                    renderContent(); // Re-render if on relevant pages
                }
            }, (error) => {
                console.error("Error fetching visitor logs:", error);
                updateMessage(`Error fetching visitor logs: ${error.message}`);
            });
        }

        function unsubscribeAllFirestoreListeners() {
            if (unsubscribePrincipalApprovals) {
                unsubscribePrincipalApprovals();
                unsubscribePrincipalApprovals = null;
            }
            if (unsubscribeRegisteredVisitors) {
                unsubscribeRegisteredVisitors();
                unsubscribeRegisteredVisitors = null;
            }
            if (unsubscribeVisitorLogs) {
                unsubscribeVisitorLogs();
                unsubscribeVisitorLogs = null;
            }
            if (unsubscribeBookedAppointments) {
                unsubscribeBookedAppointments();
                unsubscribeBookedAppointments = null;
            }
            console.log("All Firestore listeners unsubscribed.");
        }

        function updatePrincipalApprovals() {
            if (principalApprovalFilter === 'All') {
                pendingApprovals = bookedAppointments;
            } else {
                pendingApprovals = bookedAppointments.filter(app => app.status === principalApprovalFilter);
            }
            // Sort by requestedAt descending
            pendingApprovals.sort((a, b) => new Date(b.requestedAt) - new Date(a.requestedAt));
            console.log(`Filtered approvals (${principalApprovalFilter}):`, pendingApprovals);
        }

        // --- Initialization ---

        // Firebase App and Auth Initialization
        const firebaseConfig = {
  apiKey: "AIzaSyAthVRHTOjGf9NLSVu3o80TS1GMmPYUNaE",
  authDomain: "knp-vms-app.firebaseapp.com",
  projectId: "knp-vms-app",
  storageBucket: "knp-vms-app.firebasestorage.app",
  messagingSenderId: "906443986354",
  appId: "1:906443986354:web:9e54514af8f765df9940ab",
  measurementId: "G-GJKFBDR7N8"
};

        // This flag will be set to true once Firebase Auth is fully initialized and an initial auth state is determined.
        let isFirebaseAuthInitialized = false;

        if (Object.keys(firebaseConfig).length > 0) {
            const firebaseApp = initializeApp(firebaseConfig);
            db = getFirestore(firebaseApp); // Initialize db here
            auth = getAuth(firebaseApp); // Initialize auth here

            // Listen for authentication state changes
            onAuthStateChanged(auth, async (user) => {
                if (!isFirebaseAuthInitialized) { // This block runs only once on initial auth state determination
                    console.log("onAuthStateChanged: Initial check, user:", user);
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            const userCredential = await signInWithCustomToken(auth, __initial_auth_token);
                            userId = userCredential.user.uid;
                            userEmail = userCredential.user.email || 'Admin'; // Fallback for anonymous
                            isLoggedIn = true;
                            console.log("Signed in with custom token:", userId);
                        } catch (error) {
                            console.error("Error signing in with custom token:", error);
                            // Fallback to anonymous if custom token fails
                            try {
                                const userCredential = await signInAnonymously(auth);
                                userId = userCredential.user.uid;
                                userEmail = 'Anonymous';
                                isLoggedIn = true;
                                console.log("Signed in anonymously:", userId);
                            } catch (anonError) {
                                console.error("Error signing in anonymously:", anonError);
                                updateLoginMessage(`Authentication failed: ${anonError.message}`);
                                // If even anonymous sign-in fails, keep login button disabled
                                return;
                            }
                        }
                    } else {
                        // If no custom token, sign in anonymously
                        try {
                            const userCredential = await signInAnonymously(auth);
                            userId = userCredential.user.uid;
                            userEmail = 'Anonymous';
                            isLoggedIn = true;
                            console.log("Signed in anonymously (no custom token):", userId);
                        } catch (anonError) {
                            console.error("Error signing in anonymously:", anonError);
                            updateLoginMessage(`Authentication failed: ${anonError.message}`);
                            // If even anonymous sign-in fails, keep login button disabled
                            return;
                        }
                    }

                    isAuthReady = true; // Set global flag for auth readiness
                    isFirebaseAuthInitialized = true; // Mark initial auth process as complete
                    console.log("isAuthReady set to true, isFirebaseAuthInitialized set to true.");

                    setupFirestoreListeners(); // Setup listeners AFTER auth is ready

                    // Enable login button and clear message after auth is ready
                    const loginSubmitButton = document.getElementById('loginSubmitButton');
                    if (loginSubmitButton) {
                        loginSubmitButton.disabled = false;
                        updateLoginMessage('Ready to log in.'); // Clear the "initializing" message
                    }

                    if (isLoggedIn) {
                        renderMainApp();
                    } else {
                        renderLoginForm(); // Show login form if not logged in
                    }
                } else if (!user && isLoggedIn) { // This block runs on subsequent auth state changes, e.g., user logout
                    console.log("Auth state changed: User logged out.");
                    isLoggedIn = false;
                    userId = null;
                    userEmail = null;
                    unsubscribeAllFirestoreListeners();
                    renderLoginForm();
                    // Re-enable login button on logout
                    const loginSubmitButton = document.getElementById('loginSubmitButton');
                    if (loginSubmitButton) {
                        loginSubmitButton.disabled = false;
                        updateLoginMessage('Logged out. Please log in.');
                    }
                }
            });
        } else {
            console.error("Firebase config not found. App will not function correctly.");
            updateLoginMessage("Firebase configuration missing. Please provide it for full functionality.");
            // Keep login button disabled if Firebase config is missing
            const loginSubmitButton = document.getElementById('loginSubmitButton');
            if (loginSubmitButton) {
                loginSubmitButton.disabled = true;
            }
            renderLoginForm(); // Show login screen but it won't work
        }

        // Get the app-content div once the DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            appContent = document.getElementById('app-content');
            if (!appContent) {
                console.error("app-content div not found!");
            }
            // Initial render of login form with disabled button and initializing message
            renderLoginForm();
            // attachLoginEventListeners is now called here to ensure the form's submit handler is set up early.
            // The handler itself checks `isAuthReady`.
            attachLoginEventListeners();
        });
    </script>
</body>
</html>
